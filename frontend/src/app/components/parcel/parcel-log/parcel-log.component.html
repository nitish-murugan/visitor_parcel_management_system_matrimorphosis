<div class="parcel-log-container">
  <!-- All Parcels Records Section -->
  <mat-card class="parcel-records-card" *ngIf="viewMode">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>inventory_2</mat-icon>
        All Parcel Records
      </mat-card-title>
      <mat-card-subtitle>View all registered parcels</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <div *ngIf="isLoadingParcels" class="loading-container">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Loading parcel records...</p>
      </div>

      <div
        *ngIf="!isLoadingParcels && parcels.length === 0"
        class="empty-state"
      >
        <mat-icon>inventory_2</mat-icon>
        <p>No parcel records found</p>
      </div>

      <div
        *ngIf="!isLoadingParcels && parcels.length > 0"
        class="table-container"
      >
        <table mat-table [dataSource]="parcels" class="parcel-table">
          <!-- ID Column -->
          <ng-container matColumnDef="id">
            <th mat-header-cell *matHeaderCellDef>ID</th>
            <td mat-cell *matCellDef="let parcel">{{ parcel.id }}</td>
          </ng-container>

          <!-- Parcel Number Column -->
          <ng-container matColumnDef="parcelNumber">
            <th mat-header-cell *matHeaderCellDef>Parcel Number</th>
            <td mat-cell *matCellDef="let parcel">{{ parcel.parcelNumber }}</td>
          </ng-container>

          <!-- Resident Column -->
          <ng-container matColumnDef="residentId">
            <th mat-header-cell *matHeaderCellDef>Resident</th>
            <td mat-cell *matCellDef="let parcel">
              {{ getResidentName(parcel.residentId) }}
            </td>
          </ng-container>

          <!-- Sender Name Column -->
          <ng-container matColumnDef="senderName">
            <th mat-header-cell *matHeaderCellDef>Sender</th>
            <td mat-cell *matCellDef="let parcel">{{ parcel.senderName }}</td>
          </ng-container>

          <!-- Sender Phone Column -->
          <ng-container matColumnDef="senderPhone">
            <th mat-header-cell *matHeaderCellDef>Sender Phone</th>
            <td mat-cell *matCellDef="let parcel">
              {{ parcel.senderPhone || "N/A" }}
            </td>
          </ng-container>

          <!-- Description Column -->
          <ng-container matColumnDef="description">
            <th mat-header-cell *matHeaderCellDef>Description</th>
            <td mat-cell *matCellDef="let parcel">
              {{ parcel.description || "N/A" }}
            </td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let parcel">
              <span
                class="status-badge"
                [ngClass]="getStatusBadgeClass(parcel.status)"
              >
                {{ parcel.status }}
              </span>
            </td>
          </ng-container>

          <!-- Received At Column -->
          <ng-container matColumnDef="receivedAt">
            <th mat-header-cell *matHeaderCellDef>Received At</th>
            <td mat-cell *matCellDef="let parcel">
              {{ formatDateTime(parcel.receivedAt) }}
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
        </table>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Log New Parcel Section -->
  <mat-card class="log-card" *ngIf="!viewMode">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>local_shipping</mat-icon>
        Log Incoming Parcel
      </mat-card-title>
      <mat-card-subtitle
        >Record new parcel delivery for residents</mat-card-subtitle
      >
    </mat-card-header>

    <mat-card-content>
      <mat-progress-bar
        mode="indeterminate"
        *ngIf="isSubmitting"
      ></mat-progress-bar>
      <form [formGroup]="parcelForm" (ngSubmit)="onSubmit()">
        <!-- Resident Selection + Parcel Number (responsive row) -->
        <div class="form-row">
          <mat-form-field appearance="outline" class="half-width">
            <mat-label>Select Resident *</mat-label>
            <mat-select formControlName="residentId">
              <mat-option
                *ngFor="let resident of residents"
                [value]="resident.id"
              >
                {{ resident.name }}
              </mat-option>
            </mat-select>
            <mat-icon matPrefix>person</mat-icon>
            <mat-hint>Choose the resident receiving the parcel</mat-hint>
            <mat-error>{{ getErrorMessage("residentId") }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="half-width">
            <mat-label>Parcel Number *</mat-label>
            <input
              matInput
              formControlName="parcelNumber"
              placeholder="e.g., PKG-2025-001"
            />
            <mat-icon matPrefix>confirmation_number</mat-icon>
            <mat-hint>Minimum 3 characters (e.g., PKG-001)</mat-hint>
            <mat-error>{{ getErrorMessage("parcelNumber") }}</mat-error>
          </mat-form-field>
        </div>

        <!-- Sender Name + Phone (responsive row) -->
        <div class="form-row">
          <mat-form-field appearance="outline" class="half-width">
            <mat-label>Sender Name *</mat-label>
            <input
              matInput
              formControlName="senderName"
              placeholder="Full name of sender"
            />
            <mat-icon matPrefix>account_circle</mat-icon>
            <mat-hint>Minimum 2 characters</mat-hint>
            <mat-error>{{ getErrorMessage("senderName") }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="half-width">
            <mat-label>Sender Phone</mat-label>
            <input
              matInput
              formControlName="senderPhone"
              placeholder="10-digit phone number"
              maxlength="10"
            />
            <mat-icon matPrefix>phone</mat-icon>
            <mat-hint>Format: 10-digit number (optional)</mat-hint>
            <mat-error>{{ getErrorMessage("senderPhone") }}</mat-error>
          </mat-form-field>
        </div>

        <!-- Description -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Parcel Description</mat-label>
          <textarea
            matInput
            formControlName="description"
            rows="3"
            placeholder="Describe the parcel contents (optional)"
          ></textarea>
          <mat-icon matPrefix>description</mat-icon>
          <mat-hint>Provide details about what's in the parcel</mat-hint>
        </mat-form-field>

        <!-- Photo Upload Section -->
        <div class="photo-section">
          <h3 class="section-title">
            <mat-icon>photo_camera</mat-icon>
            Parcel Photo
          </h3>

          <div *ngIf="!photoPreview" class="photo-upload">
            <input
              #photoInput
              type="file"
              accept="image/*"
              (change)="onPhotoSelected($event)"
              hidden
            />
            <button
              mat-raised-button
              color="accent"
              type="button"
              (click)="photoInput.click()"
            >
              <mat-icon>add_photo_alternate</mat-icon>
              Upload Photo
            </button>
            <p class="upload-hint">PNG, JPG or GIF up to 5MB (optional)</p>
          </div>

          <div *ngIf="photoPreview" class="photo-preview">
            <img [src]="photoPreview" alt="Parcel preview" />
            <button
              mat-icon-button
              color="warn"
              type="button"
              (click)="removePhoto()"
              class="remove-btn"
            >
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="form-actions">
          <button
            mat-raised-button
            color="primary"
            type="submit"
            [disabled]="parcelForm.invalid || isSubmitting"
            class="submit-btn"
          >
            <mat-icon *ngIf="!isSubmitting">check_circle</mat-icon>
            <mat-spinner
              *ngIf="isSubmitting"
              diameter="20"
              class="spinner"
            ></mat-spinner>
            {{ isSubmitting ? "Logging..." : "Log Parcel" }}
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</div>
